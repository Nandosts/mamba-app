<AppBarModifier title="Características" />

<ul class="character-data">
  <li>
    Nome: {$character.name}
  </li>
  <li>
    Altura: {$character.height}
  </li>
  <li>
    Massa: {$character.mass}
  </li>
  <li>
    Cor do Cabelo: {$character.hair_color}
  </li>
  <li>
    Cor de pele: {$character.skin_color}
  </li>
  <li class="eyes-color">
    Cor dos olhos: {$character.eye_color}
    <div
      class="eyes-color-block"
      style="background: {$character.eye_color};"
    ></div>
  </li>
  <li>
    Ano de nascimento: {$character.birth_year}
  </li>
  <li>
    Gênero: {$character.gender}
  </li>
  <li>
    Mundo de origem: {$character.homeworld || ""}
  </li>
  <ul>
    Filmes: {#each $character.films as film}
    <li class="film-item">
      {film}
    </li>
    {/each}
  </ul>
</ul>
<a href="/">Voltar</a>

<script>
  import Storage from '@mamba/pos/api/storage.js';
  import Http from '@mamba/pos/api/http.js';
  import { Store } from 'svelte/store.js';

  let characters = Storage.getItem('starWarsCharacters');
  let characterSelected = Math.floor(Math.random() * characters.length);
  Storage.setItem('starWarsCharacters', characters);

  let character = characters[characterSelected];
  const store = new Store({
    character,
  });
  let filmUrls = character.films;
  let films = [];
  let homeworld = '';

  function setWorldName() {
    const world = character.homeworld;

    const myRequest = {
      url: world,
      method: 'GET',
      data: {},
      proxy: true,
    };
    Http.send(myRequest)
      .then(result => {
        // in case the request have no errors
        const worldName = JSON.parse(result.body).name;
        homeworld =
          worldName && worldName !== 'unknown' ? worldName : 'Desconhecido';
      })
      .catch(error => {
        // if the request fails
        console.error(error.status);
        console.error(error.msg);
      });
  }

  function setFilmsName() {
    filmUrls.forEach(async filmUrl => {
      const myRequest = {
        url: filmUrl,
        method: 'GET',
        data: {},
        proxy: true,
      };
      await Http.send(myRequest)
        .then(result => {
          // in case the request have no errors
          const filmName = JSON.parse(result.body).title;
          films = films.concat(filmName);
          store.set({
            character: {
              ...character,
              homeworld,
              films,
            },
          });
        })
        .catch(error => {
          // if the request fails
          console.error(error.status);
          console.error(error.msg);
        });
    });
    films = [];
  }

  export default {
    components: {
      AppBarModifier: '@mamba/appbar/Modifier.html',
    },
    store: () => store,
    data() {
      return {
        character,
      };
    },
    async oncreate() {
      characters = Storage.getItem('starWarsCharacters');
      characterSelected = Math.floor(Math.random() * characters.length);
      characters[characterSelected].selected = true;
      Storage.setItem('starWarsCharacters', characters);

      character = characters[characterSelected];
      filmUrls = character.films;
      films = [];
      homeworld = '';

      store.set({
        character: {
          ...character,
        },
      });

      setWorldName();
      await setFilmsName();
    },
    methods: {},
  };
</script>

<style type="text/postcss">
  .character-data {
    padding: 1.25rem;
    font-size: 1rem;
  }

  .eyes-color {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .eyes-color-block {
    content: '.';
    border-radius: 50%;
    box-shadow: 0 0 1px black;
    width: 1.25rem;
    height: 1.25rem;
    margin-right: 2rem;
  }

  .film-item {
    list-style: disc inside;
  }
</style>
